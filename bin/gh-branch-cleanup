#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

list_prs() {
	gh pr list --state merged --author "@me" --json "number,title,headRefName,headRefOid" |
		jq -r '.[] | [.number, .title, .headRefName, .headRefOid] | @tsv'
}

warn() {
	echo "WARN:" "$@" >&2
}

while read -r NUMBER TITLE BRANCH OID; do
	branchAt=$(git rev-parse --verify "refs/heads/${BRANCH}" 2>/dev/null || echo "")
	if [[ -z "${branchAt}" ]]; then
		continue
	elif [[ "${branchAt}" != "${OID}" ]]; then
		warn "Skipping updated branch: ${BRANCH} (#${NUMBER}: ${TITLE})"
	else
		echo "Deleting ${BRANCH} (#${NUMBER}: ${TITLE})"
		git branch -D "${BRANCH}"
	fi
done < <(list_prs)
